{"version":3,"file":"diffuseSkyIrradianceLut.js","sourceRoot":"","sources":["../../../../dev/addons/src/atmosphere/diffuseSkyIrradianceLut.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\r\n// Licensed under the MIT License.\r\n\r\nimport type { Atmosphere } from \"./atmosphere\";\r\nimport type { AtmospherePhysicalProperties } from \"./atmospherePhysicalProperties\";\r\nimport { Clamp } from \"core/Maths/math.scalar.functions\";\r\nimport { Constants } from \"core/Engines/constants\";\r\nimport { EffectRenderer, EffectWrapper } from \"core/Materials/effectRenderer\";\r\nimport { FromHalfFloat } from \"core/Misc/textureTools\";\r\nimport type { IColor3Like, IColor4Like, IVector2Like, IVector3Like } from \"core/Maths/math.like\";\r\nimport type { Nullable } from \"core/types\";\r\nimport { RenderTargetTexture } from \"core/Materials/Textures/renderTargetTexture\";\r\nimport { Sample2DRgbaToRef } from \"./sampling\";\r\nimport { Vector3Dot } from \"core/Maths/math.vector.functions\";\r\nimport \"./Shaders/diffuseSkyIrradiance.fragment\";\r\nimport \"./Shaders/fullscreenTriangle.vertex\";\r\n\r\nconst RaySamples = 128;\r\nconst LutWidthPx = 64;\r\nconst LutHeightPx = 16;\r\nconst HalfTexelSize = { x: 0.5 / LutWidthPx, y: 0.5 / LutHeightPx };\r\nconst UnitToUVScale = { x: (LutWidthPx - 1.0) / LutWidthPx, y: (LutHeightPx - 1.0) / LutHeightPx };\r\nconst UvTemp = { x: Number.NaN, y: Number.NaN };\r\nconst Color4Temp = { r: Number.NaN, g: Number.NaN, b: Number.NaN, a: Number.NaN } as IColor4Like;\r\n\r\nconst ComputeLutUVToRef = (properties: AtmospherePhysicalProperties, radius: number, cosAngleLightToZenith: number, result: IVector2Like): void => {\r\n    const unitX = Clamp(0.5 + 0.5 * cosAngleLightToZenith);\r\n    const unitY = Clamp((radius - properties.planetRadius) / properties.atmosphereThickness);\r\n    result.x = unitX * UnitToUVScale.x + HalfTexelSize.x;\r\n    result.y = unitY * UnitToUVScale.y + HalfTexelSize.y;\r\n};\r\n\r\n/**\r\n * The diffuse sky irradiance LUT is used to query the diffuse irradiance at a specified position.\r\n */\r\nexport class DiffuseSkyIrradianceLut {\r\n    private readonly _atmosphere: Atmosphere;\r\n    private _renderTarget: Nullable<RenderTargetTexture> = null;\r\n    private _effectWrapper: Nullable<EffectWrapper> = null;\r\n    private _effectRenderer: Nullable<EffectRenderer> = null;\r\n    private _isDirty = true;\r\n    private _isDisposed = false;\r\n    private _lutData: Uint8Array | Uint16Array = new Uint16Array(0);\r\n\r\n    /**\r\n     * True if the LUT needs to be rendered.\r\n     */\r\n    public get isDirty() {\r\n        return this._isDirty;\r\n    }\r\n\r\n    /**\r\n     * True if the LUT has been disposed.\r\n     */\r\n    public get isDisposed(): boolean {\r\n        return this._isDisposed;\r\n    }\r\n\r\n    /**\r\n     * The render target used for this LUT.\r\n     * @throws if the LUT has been disposed.\r\n     */\r\n    public get renderTarget(): RenderTargetTexture {\r\n        if (this._isDisposed || this._renderTarget === null) {\r\n            throw new Error();\r\n        }\r\n        return this._renderTarget;\r\n    }\r\n\r\n    /**\r\n     * True if the LUT data has been read back from the GPU.\r\n     */\r\n    public get hasLutData(): boolean {\r\n        return this._lutData[0] !== undefined;\r\n    }\r\n\r\n    /**\r\n     * Constructs the {@link DiffuseSkyIrradianceLut}.\r\n     * @param atmosphere - The atmosphere to use.\r\n     */\r\n    constructor(atmosphere: Atmosphere) {\r\n        this._atmosphere = atmosphere;\r\n        const scene = atmosphere.scene;\r\n        const engine = scene.getEngine();\r\n\r\n        const name = \"atmo-diffuseSkyIrradiance\";\r\n        const caps = engine.getCaps();\r\n        const textureType = caps.textureHalfFloatRender ? Constants.TEXTURETYPE_HALF_FLOAT : Constants.TEXTURETYPE_UNSIGNED_BYTE;\r\n        const renderTarget = (this._renderTarget = new RenderTargetTexture(name, { width: LutWidthPx, height: LutHeightPx }, scene, {\r\n            generateMipMaps: false,\r\n            type: textureType,\r\n            samplingMode: Constants.TEXTURE_BILINEAR_SAMPLINGMODE,\r\n            generateDepthBuffer: false,\r\n            gammaSpace: false,\r\n        }));\r\n        renderTarget.wrapU = Constants.TEXTURE_CLAMP_ADDRESSMODE;\r\n        renderTarget.wrapV = Constants.TEXTURE_CLAMP_ADDRESSMODE;\r\n        renderTarget.anisotropicFilteringLevel = 1;\r\n        renderTarget.skipInitialClear = true;\r\n\r\n        const atmosphereUbo = atmosphere.uniformBuffer;\r\n        const useUbo = atmosphereUbo.useUbo;\r\n\r\n        const heightParam = engine.isWebGPU ? \"radius\" : \"filteringInfo.x\";\r\n        this._effectWrapper = new EffectWrapper({\r\n            engine,\r\n            name,\r\n            vertexShader: \"fullscreenTriangle\",\r\n            fragmentShader: \"diffuseSkyIrradiance\",\r\n            attributeNames: [\"position\"],\r\n            uniformNames: [\"depth\", ...(useUbo ? [] : atmosphereUbo.getUniformNames())],\r\n            uniformBuffers: useUbo ? [atmosphereUbo.name] : [],\r\n            defines: [\r\n                \"#define POSITION_VEC2\",\r\n                `#define NUM_SAMPLES ${RaySamples}u`,\r\n                \"#define CUSTOM_IRRADIANCE_FILTERING_INPUT /* empty */\", // empty, no input texture needed as the radiance is procedurally generated from ray marching.\r\n                // The following ray marches the atmosphere to get the radiance.\r\n                `#define CUSTOM_IRRADIANCE_FILTERING_FUNCTION vec3 c = integrateForIrradiance(n, Ls, vec3(0., ${heightParam}, 0.));`,\r\n            ],\r\n            samplers: [\"transmittanceLut\", \"multiScatteringLut\"],\r\n            useShaderStore: true,\r\n        });\r\n\r\n        this._effectRenderer = new EffectRenderer(engine, {\r\n            // Full screen triangle.\r\n            indices: [0, 2, 1],\r\n            positions: [-1, -1, -1, 3, 3, -1],\r\n        });\r\n\r\n        // The sky irradiance will also be used for the environment texture.\r\n        scene.environmentTexture = renderTarget;\r\n        scene.environmentTexture.irradianceTexture = renderTarget;\r\n        scene.environmentIntensity = 1.0;\r\n\r\n        // Prevent the irradiance LUT from being rendered redundantly at the beginning of the frame.\r\n        scene.environmentTexture.isRenderTarget = false;\r\n    }\r\n\r\n    /**\r\n     * Gets the diffuse sky irradiance for a surface oriented along the geocentric normal.\r\n     * Resulting color is always in linear space.\r\n     * @param directionToLight - The direction to the light in world space.\r\n     * @param radius - The position's distance to the planet origin.\r\n     * @param cameraGeocentricNormal - The geocentric normal of the camera.\r\n     * @param lightIrradiance - The irradiance of the light.\r\n     * @param result - The color to store the result in.\r\n     * @returns The result color.\r\n     */\r\n    public getDiffuseSkyIrradianceToRef<T extends IColor3Like>(\r\n        directionToLight: IVector3Like,\r\n        radius: number,\r\n        cameraGeocentricNormal: IVector3Like,\r\n        lightIrradiance: number,\r\n        result: T\r\n    ): T {\r\n        const atmosphere = this._atmosphere;\r\n        const additionalDiffuseSkyIrradiance = atmosphere.additionalDiffuseSkyIrradiance;\r\n\r\n        const properties = atmosphere.physicalProperties;\r\n        if (this._lutData[0] === undefined || radius > properties.atmosphereRadius) {\r\n            result.r = additionalDiffuseSkyIrradiance.r;\r\n            result.g = additionalDiffuseSkyIrradiance.g;\r\n            result.b = additionalDiffuseSkyIrradiance.b;\r\n            return result;\r\n        }\r\n\r\n        const cosAngleLightToZenith = Vector3Dot(directionToLight, cameraGeocentricNormal);\r\n        ComputeLutUVToRef(properties, radius, cosAngleLightToZenith, UvTemp);\r\n        Sample2DRgbaToRef(UvTemp.x, UvTemp.y, LutWidthPx, LutHeightPx, this._lutData, Color4Temp, FromHalfFloat);\r\n\r\n        const intensity = atmosphere.diffuseSkyIrradianceIntensity;\r\n        result.r = intensity * (lightIrradiance * Color4Temp.r + additionalDiffuseSkyIrradiance.r);\r\n        result.g = intensity * (lightIrradiance * Color4Temp.g + additionalDiffuseSkyIrradiance.g);\r\n        result.b = intensity * (lightIrradiance * Color4Temp.b + additionalDiffuseSkyIrradiance.b);\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Renders the LUT.\r\n     * @returns True if the LUT was rendered.\r\n     */\r\n    public render(): boolean {\r\n        // Only need to render the LUT once.\r\n        const effectWrapper = this._effectWrapper;\r\n        if (!this._isDirty || !effectWrapper?.isReady() || !this._renderTarget?.isReady()) {\r\n            return false;\r\n        }\r\n\r\n        const engine = this._atmosphere.scene.getEngine();\r\n\r\n        engine.bindFramebuffer(this.renderTarget.renderTarget!, undefined, undefined, undefined, true);\r\n\r\n        const effectRenderer = this._effectRenderer!;\r\n        effectRenderer.applyEffectWrapper(effectWrapper);\r\n\r\n        effectRenderer.saveStates();\r\n        effectRenderer.setViewport();\r\n\r\n        const effect = effectWrapper.effect;\r\n        effectRenderer.bindBuffers(effect);\r\n\r\n        effect.setTexture(\"transmittanceLut\", this._atmosphere.transmittanceLut!.renderTarget);\r\n        effect.setTexture(\"multiScatteringLut\", this._atmosphere.multiScatteringLutRenderTarget);\r\n\r\n        this._atmosphere.bindUniformBufferToEffect(effect);\r\n\r\n        effect.setFloat(\"depth\", 0.0);\r\n\r\n        effectRenderer.draw();\r\n\r\n        effectRenderer.restoreStates();\r\n        engine.restoreDefaultFramebuffer();\r\n\r\n        this._isDirty = false;\r\n\r\n        // eslint-disable-next-line github/no-then\r\n        void this.renderTarget.readPixels(0, 0, undefined, undefined, true /* noDataConversion */)?.then((value: ArrayBufferView) => {\r\n            if (this._isDisposed) {\r\n                return;\r\n            }\r\n            this._lutData = value as Uint8Array | Uint16Array;\r\n        });\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Marks the LUT as needing to be rendered.\r\n     */\r\n    public markDirty(): void {\r\n        this._isDirty = true;\r\n    }\r\n\r\n    /**\r\n     * Disposes the LUT.\r\n     */\r\n    public dispose() {\r\n        if (this._renderTarget) {\r\n            this._renderTarget.irradianceTexture = null;\r\n            this._renderTarget.dispose();\r\n        }\r\n        this._renderTarget = null;\r\n        this._effectWrapper?.dispose();\r\n        this._effectWrapper = null;\r\n        this._effectRenderer?.dispose();\r\n        this._effectRenderer = null;\r\n        this._isDisposed = true;\r\n    }\r\n}\r\n"]}