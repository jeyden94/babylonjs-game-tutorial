{"version":3,"file":"fontAsset.js","sourceRoot":"","sources":["../../../../dev/addons/src/msdfText/fontAsset.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IDisposable, Scene } from \"core/scene\";\r\nimport type { BMFontChar } from \"./sdf/bmFont\";\r\nimport type { SdfFont } from \"./sdf/font\";\r\nimport { Texture } from \"core/Materials/Textures/texture\";\r\n\r\nenum CharCode {\r\n    SPACE = 32,\r\n    TOFU = 0xfffc,\r\n}\r\n\r\n/**\r\n * Class representing a font asset for SDF (Signed Distance Field) rendering.\r\n */\r\nexport class FontAsset implements IDisposable {\r\n    private readonly _chars = new Map<number, BMFontChar>();\r\n    private readonly _charsRegex: RegExp;\r\n    private readonly _kernings = new Map<number, Map<number, number>>();\r\n\r\n    /** @internal */\r\n    public readonly _font: SdfFont;\r\n\r\n    /**\r\n     * Gets the font scale value\r\n     */\r\n    public readonly scale: number;\r\n\r\n    /**\r\n     * Gets the list of used textures\r\n     */\r\n    public readonly textures: Texture[];\r\n\r\n    /**\r\n     * Creates a new FontAsset instance.\r\n     * @param definitionData defines the font data in JSON format.\r\n     * @param textureUrl defines the url of the texture to use for the font.\r\n     * @param scene defines the hosting scene.\r\n     */\r\n    public constructor(definitionData: string, textureUrl: string, scene?: Scene) {\r\n        this._font = JSON.parse(definitionData) as SdfFont;\r\n        // So far we only consider one page\r\n        this._font.pages = [textureUrl];\r\n\r\n        this._font.chars.forEach((char) => this._chars.set(char.id, char));\r\n        this._font.kernings.forEach((kerning) => {\r\n            let submap = this._kernings.get(kerning.first);\r\n            if (!submap) {\r\n                submap = new Map();\r\n                this._kernings.set(kerning.first, submap);\r\n            }\r\n            submap.set(kerning.second, kerning.amount);\r\n        });\r\n        this._charsRegex = new RegExp(`[${this._font.chars.map((c) => c.char.replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g, \"\\\\$&\")).join(\"\")}]`, \"g\");\r\n\r\n        this._updateFallbacks();\r\n\r\n        this.scale = 1 / this._font.info.size;\r\n        this.textures = this._font.pages.map((page) => {\r\n            const texture = new Texture(page, scene, { noMipmap: false, invertY: false });\r\n            texture.anisotropicFilteringLevel = 16;\r\n            return texture;\r\n        });\r\n    }\r\n\r\n    dispose(): void {\r\n        for (const texture of this.textures) {\r\n            texture.dispose();\r\n        }\r\n        this.textures.length = 0;\r\n    }\r\n\r\n    private _updateFallbacks() {\r\n        if (!this._chars.has(CharCode.SPACE)) {\r\n            this._chars.set(CharCode.SPACE, {\r\n                id: CharCode.SPACE,\r\n                x: 0,\r\n                y: 0,\r\n                width: 0,\r\n                height: 0,\r\n                xoffset: 0,\r\n                yoffset: 0,\r\n                xadvance: this._font.info.size * 0.5,\r\n                page: -1,\r\n                chnl: -1,\r\n                index: -1,\r\n                char: \" \",\r\n            });\r\n        }\r\n\r\n        if (!this._chars.has(CharCode.TOFU)) {\r\n            this._chars.set(CharCode.TOFU, {\r\n                id: CharCode.TOFU,\r\n                x: 0,\r\n                y: 0,\r\n                width: this._font.info.size,\r\n                height: this._font.info.size,\r\n                xoffset: 0,\r\n                yoffset: 0,\r\n                xadvance: this._font.info.size * 0.5,\r\n                page: -1,\r\n                chnl: -1,\r\n                index: -1,\r\n                char: \"ï¿¿\",\r\n            });\r\n        }\r\n    }\r\n\r\n    /** @internal */\r\n    public _getChar(charCode: number) {\r\n        return this._chars.get(charCode) || this._chars.get(CharCode.TOFU)!;\r\n    }\r\n\r\n    /** @internal */\r\n    public _getKerning(first: number, second: number) {\r\n        return this._kernings.get(first)?.get(second) || 0;\r\n    }\r\n\r\n    /** @internal */\r\n    public _unsupportedChars(text: string) {\r\n        return text.replace(this._charsRegex, \"\");\r\n    }\r\n}\r\n"]}